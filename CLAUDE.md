# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**ClonalSim** is a Bioconductor-compatible R package for simulating tumor clonal evolution with realistic sequencing noise. It generates mutational profiles of tumor samples with hierarchical clonal structure, including:
- Founder mutations (present in all subclones)
- Shared mutations (present in subgroups according to evolutionary hierarchy)
- Private mutations (specific to individual subclones)
- Realistic biological noise (Beta distribution for intra-tumor heterogeneity)
- Realistic technical sequencing noise (negative binomial depth, binomial sampling, base errors)

The package outputs VAF (Variant Allele Frequency) data that mimics real tumor sequencing, designed for benchmarking variant callers, testing clonal deconvolution algorithms, and teaching tumor heterogeneity concepts.

## Package Structure

ClonalSim is a **standard R package** (not a standalone script):

```
ClonalSim/
├── DESCRIPTION              # Package metadata
├── NAMESPACE                # Exported functions (roxygen2-generated)
├── R/                       # R source code
│   ├── AllClasses.R         # S4 ClonalSimData class
│   ├── accessors.R          # Getter functions
│   ├── methods.R            # show, summary, plot methods
│   ├── noise_model.R        # Noise simulation functions
│   ├── simulateTumor.R      # Main simulation function
│   ├── bioconductor.R       # Export functions (GRanges, VCF, etc.)
│   └── ClonalSim-package.R  # Package documentation
├── man/                     # Documentation (auto-generated by roxygen2)
├── tests/testthat/          # Unit tests
├── vignettes/               # Long-form documentation
└── inst/scripts/            # Original standalone script (legacy)
```

## Key Commands

### Package Development

```bash
# Document with roxygen2
R -e "devtools::document()"

# Build package
R CMD build .

# Check package
R -e "devtools::check()"

# Install locally
R -e "devtools::install()"

# Run tests
R -e "devtools::test()"
```

### Using the Package

```r
# Load package
library(ClonalSim)

# Run simulation
sim <- simulateTumor()

# View results
sim                          # Print summary
summary(sim)                 # Detailed statistics

# Visualization (requires ggplot2)
library(ggplot2)
plot(sim, type = "vaf_density")

# Get data
mutations <- getMutations(sim)
true_vaf <- getTrueVAF(sim)
observed_vaf <- getObservedVAF(sim)

# Export
gr <- toGRanges(sim)         # To GenomicRanges
toVCF(sim, "output.vcf")     # To VCF
toPyClone(sim, "pyclone.tsv") # For PyClone
```

### Legacy Standalone Script

The original script is preserved in `inst/scripts/simulate_tumor_clones.R`:

```r
# From package directory
source("inst/scripts/simulate_tumor_clones.R")

# After package installation
source(system.file("scripts", "simulate_tumor_clones.R", package = "ClonalSim"))
```

## Code Architecture

### S4 Class System

**ClonalSimData Class** (`R/AllClasses.R`)
- **Slots:**
  - `mutations`: data.frame with mutation data
  - `params`: list of simulation parameters
  - `clonal_structure`: data.frame of clone hierarchy
  - `metadata`: list with version, date, seed
- **Methods:**
  - `show()`: Console display
  - `summary()`: Statistical summary
  - `plot()`: Visualization (4 types: vaf_density, vaf_scatter, depth_histogram, clone_matrix)
- **Validation:** Checks VAF bounds, depth positivity, alt_reads ≤ depth

### Main Functions

**1. simulateTumor()** (`R/simulateTumor.R`)
- Main entry point for simulations
- Parameters:
  - `subclone_freqs`: Clone frequencies (default: c(0.15, 0.25, 0.30, 0.30))
  - `n_mut_per_clone`: Private mutations per clone
  - `n_mut_founder`: Founder mutations
  - `n_mut_shared`: Shared mutations (named list)
  - `biological_noise`: List with `enabled`, `concentration`
  - `sequencing_noise`: List with `enabled`, `mean_depth`, `depth_variation`, `depth_dispersion`, `error_rate`, `binomial_sampling`
  - `seed`: Random seed for reproducibility
- Returns: `ClonalSimData` S4 object

**2. Noise Model Functions** (`R/noise_model.R`)
- `applyBiologicalNoise(true_freq, n_mutations, concentration)`
  - Beta distribution for intra-tumor heterogeneity
  - Returns VAF with biological variation
- `simulateDepth(n_mutations, mean_depth, distribution, dispersion)`
  - Negative binomial for coverage overdispersion
  - Returns depth vector
- `simulateSequencingReads(true_vaf, depth, error_rate)`
  - Binomial sampling + base errors
  - Returns list(vaf, alt_reads, ref_reads)

**3. Accessor Functions** (`R/accessors.R`)
- `getMutations(object)`: Extract mutations data.frame
- `getSimParams(object)`: Get simulation parameters
- `getTrueVAF(object)`: Get true (biological) VAF
- `getObservedVAF(object)`: Get observed (with noise) VAF
- `getClonalStructure(object)`: Get clone hierarchy
- `getMetadata(object)`: Get metadata

**4. Export Functions** (`R/bioconductor.R`)
- `toGRanges(object)`: Convert to GenomicRanges::GRanges
- `toVCF(object, sample_name, output_file)`: Convert to VCF/VRanges
- `toDataFrame(object, file, include_true_vaf)`: Export to data.frame/CSV
- `toPyClone(object, file, sample_id)`: Export for PyClone analysis
- `toSciClone(object, file)`: Export for SciClone analysis

### Key Design Patterns

- **S4 Object-Oriented**: Formal class system with validation
- **Modular Functions**: Each component is independent and testable
- **Two-Stage Noise Model**: Biological and technical noise separated
- **Bioconductor Integration**: Native GRanges, VRanges support
- **Documentation-First**: All functions have complete Roxygen2 docs
- **Test-Driven**: 141 test cases covering all functionality

## Important Files

### Documentation
- `man/*.Rd`: Auto-generated help files (DO NOT EDIT MANUALLY)
- `vignettes/Introduction_to_ClonalSim.Rmd`: Comprehensive tutorial
- `PACKAGE_TRANSFORMATION.md`: Summary of package creation process
- `NEWS.md`: Changelog

### Configuration
- `DESCRIPTION`: Package metadata (version, dependencies, authors)
- `NAMESPACE`: Exported functions (auto-generated by roxygen2)
- `.Rbuildignore`: Files to exclude from package build
- `.gitignore`: Files to exclude from git

### Testing
- `tests/testthat.R`: Test runner
- `tests/testthat/test-*.R`: Test files (5 files, 141 tests)

## Noise Model Details

### Biological Noise (Intra-Tumor Heterogeneity)

**Implementation:** `applyBiologicalNoise()` in `R/noise_model.R`

- Uses **Beta distribution** (more realistic than Gaussian for frequencies)
- For clone with frequency `f`: VAF ~ Beta(α, β)
  - α = f × concentration
  - β = (1-f) × concentration
- **concentration** parameter (default: 50):
  - Higher values → less variability (more homogeneous)
  - Lower values → more variability (spatial/temporal heterogeneity)
  - Typical range: 20-100

### Technical Sequencing Noise

**1. Depth Variation** (`simulateDepth()`)
- **Negative binomial distribution** (not Poisson)
- Models overdispersion from:
  - GC content bias
  - Mappability differences
  - PCR amplification artifacts
- **dispersion** parameter (default: 20):
  - Lower values → more variable coverage
  - Higher values → more uniform coverage

**2. Binomial Read Sampling** (`simulateSequencingReads()`)
- Each read independently sampled: alt_reads ~ Binomial(depth, VAF)
- Introduces stochastic variation
- Especially important at low depth or low VAF

**3. Sequencing Errors**
- Base miscall rate (default: 0.001 = 0.1% for Illumina)
- Added to true VAF before binomial sampling

## Use Cases

### Benchmarking Variant Callers
```r
sim <- simulateTumor(seed = 42)
toVCF(sim, "ground_truth.vcf")
# Compare with variant caller output
```

### Testing Clonal Deconvolution
```r
sim <- simulateTumor(subclone_freqs = c(0.2, 0.3, 0.5))
toPyClone(sim, "input.tsv")
# Run PyClone and compare results
```

### Educational Examples
```r
# Low purity tumor
sim <- simulateTumor(subclone_freqs = c(0.1, 0.15, 0.15))

# High heterogeneity
sim <- simulateTumor(biological_noise = list(concentration = 20))

# Ideal data (no noise)
sim <- simulateTumor(
  biological_noise = list(enabled = FALSE),
  sequencing_noise = list(enabled = FALSE)
)
```

## Development Workflow

### Adding New Features

1. **Create function in R/** with Roxygen2 documentation
2. **Add @export** tag if public API
3. **Run** `devtools::document()` to update NAMESPACE and man/
4. **Write tests** in tests/testthat/
5. **Update vignette** if user-facing feature
6. **Update NEWS.md** with changes

### Example: Adding New Function

```r
#' My New Function
#'
#' @param x numeric vector
#' @return numeric vector
#' @export
#'
#' @examples
#' myFunction(c(1, 2, 3))
#'
myFunction <- function(x) {
  x * 2
}
```

Then run:
```bash
R -e "devtools::document()"
R -e "devtools::test()"
```

### Documentation Standards

All exported functions must have:
- `@param` for each parameter with description
- `@return` describing return value
- `@export` if part of public API
- `@examples` with executable code
- `@references` if applicable
- Clear description paragraph

### Testing Standards

- Aim for >80% test coverage (Bioconductor requirement)
- Test normal functionality
- Test edge cases
- Test error handling
- Use `expect_error()`, `expect_warning()`, etc.

## Bioconductor Submission Checklist

Before submitting to Bioconductor:

- [ ] `devtools::check()` passes with no errors, warnings, or notes
- [ ] `BiocCheck::BiocCheck()` passes
- [ ] Test coverage >80%
- [ ] All vignettes build successfully
- [ ] DESCRIPTION has valid email and ORCID
- [ ] GitHub repository is public
- [ ] GitHub Actions CI/CD is set up
- [ ] NEWS.md is up to date
- [ ] All examples run successfully
- [ ] Package version is 0.99.x (Bioconductor pre-release)

## Common Development Tasks

### Update Documentation
```bash
R -e "devtools::document()"
```

### Run Tests
```bash
R -e "devtools::test()"
```

### Check Package
```bash
R -e "devtools::check()"
```

### Build Package
```bash
R CMD build .
```

### Install Locally
```bash
R -e "devtools::install()"
```

### Build Vignettes
```bash
R -e "devtools::build_vignettes()"
```

### Check Test Coverage
```bash
R -e "covr::package_coverage()"
```

## Troubleshooting

### "Cannot find function"
- Function not exported? Add `@export` and re-run `devtools::document()`
- Package not installed? Run `devtools::install()`
- Package not loaded? Run `library(ClonalSim)`

### "Object not found"
- S4 class not defined? Check `R/AllClasses.R`
- Need to re-document? Run `devtools::document()`

### Tests Failing
- Data changed? Update expected values in tests
- Function signature changed? Update test calls
- New validation added? Update test expectations

### Package Won't Build
- Check `devtools::check()` output for specific errors
- Ensure all dependencies are in DESCRIPTION
- Check that all .Rd files are valid

## Git Workflow

- Main branch: `main`
- Commit messages should be descriptive
- Use conventional commits format when possible
- Tag releases with version numbers

## Related Documentation

- **README.md**: User-facing documentation
- **PACKAGE_TRANSFORMATION.md**: Details of package creation
- **NEWS.md**: Changelog
- **vignettes/**: Long-form tutorials
- Package help: `?ClonalSim` or `help(package = "ClonalSim")`

## Contact

For questions about package development or structure, refer to:
- Bioconductor guidelines: https://contributions.bioconductor.org/
- R Packages book: https://r-pkgs.org/
- GitHub issues: https://github.com/gbucci/ClonalSim/issues
